Starting Container
npm warn config production Use `--omit=dev` instead.

> bot-data-service@1.0.0 prestart
> npx prisma generate --schema ../prisma/schema.prisma

npm warn config production Use `--omit=dev` instead.
Prisma schema loaded from ../prisma/schema.prisma

‚úî Generated Prisma Client (v6.14.0) to ./node_modules/.prisma/client in 132ms

Start by importing your Prisma Client (See: https://pris.ly/d/importing-client)

Tip: Want to turn off tips and other hints? https://pris.ly/tip-4-nohints


> bot-data-service@1.0.0 start
> node dist/main.js

INFO: Prometheus metrics collection enabled
INFO: Connected to Redis successfully
INFO: Redis client ready for operations
INFO: ‚úÖ Beds24 worker ready to process jobs
INFO: Processing job jobId=beds24-sync-74321984 {"jobId":"beds24-sync-74321984","type":"beds24-webhook","attempt":1,"maxAttempts":3}
INFO: Processing Beds24 webhook bookingId=74321984 action=MODIFY jobId=beds24-sync-74321984 {"jobId":"beds24-sync-74321984","bookingId":74321984,"action":"MODIFY","webhookType":"beds24-webhook"}
INFO: Starting syncSingleBooking call bookingId=74321984 action=MODIFY jobId=beds24-sync-74321984 {"jobId":"beds24-sync-74321984","bookingId":74321984,"action":"MODIFY"}
INFO: Starting sync for booking bookingId=74321984 {"bookingId":74321984}
INFO: Processing job jobId=beds24-sync-74321990 {"jobId":"beds24-sync-74321990","type":"beds24-webhook","attempt":1,"maxAttempts":3}
INFO: Processing Beds24 webhook bookingId=74321990 action=MODIFY jobId=beds24-sync-74321990 {"jobId":"beds24-sync-74321990","bookingId":74321990,"action":"MODIFY","webhookType":"beds24-webhook"}
INFO: Starting syncSingleBooking call bookingId=74321990 action=MODIFY jobId=beds24-sync-74321990 {"jobId":"beds24-sync-74321990","bookingId":74321990,"action":"MODIFY"}
INFO: Starting sync for booking bookingId=74321990 {"bookingId":74321990}
INFO: Connected to PostgreSQL (data-sync)
INFO: Redis health check passed
INFO: üîÑ Using cached Beds24 refresh token from Redis
INFO: ‚úÖ Beds24 write token loaded from cache {"tokenLength":172,"source":"redis-cache"}
INFO: ‚úÖ Beds24 client initialized successfully
INFO: üîÑ Starting BullMQ worker...
INFO: ‚úÖ BullMQ worker started successfully
INFO: [data-sync] listening on :8080
ERROR: ‚ùå Failed to sync to BD - check constraints and data bookingId=74321990 {"stack":"PrismaClientKnownRequestError: \nInvalid `prisma.booking.upsert()` invocation:\n\n\nNull constraint violation on the fields: (`leadType`)\n    at ei.handleRequestError (/app/data-sync/node_modules/.prisma/client/runtime/library.js:124:7283)\n    at ei.handleAndLogRequestError (/app/data-sync/node_modules/.prisma/client/runtime/library.js:124:6608)\n    at ei.request (/app/data-sync/node_modules/.prisma/client/runtime/library.js:124:6315)\n    at async a (/app/data-sync/node_modules/.prisma/client/runtime/library.js:133:9551)\n    at async processSingleBookingData (file:///app/data-sync/dist/providers/beds24/sync.js:76:24)\n    at async syncSingleBooking (file:///app/data-sync/dist/providers/beds24/sync.js:19:16)\n    at async Worker.connection [as processFn] (file:///app/data-sync/dist/infra/queues/queue.manager.js:45:36)\n    at async /app/data-sync/node_modules/bullmq/dist/cjs/classes/worker.js:496:32\n    at async Worker.retryIfFailed (/app/data-sync/node_modules/bullmq/dist/cjs/classes/worker.js:774:24)","bookingId":74321990,"data":{"id":74321990,"masterId":null,"propertyId":173308,"roomId":378317,"unitId":1,"roomQty":1,"offerId":1,"status":"confirmed","subStatus":"none","arrival":"2025-08-26","departure":"2025-08-28","numAdult":2,"numChild":0,"title":"RESERVA NUEVA 2","firstName":"CAMBIO","lastName":"","email":"","phone":"","mobile":"","fax":"","company":"","address":"","city":"","state":"","postcode":"","country":"","country2":null,"arrivalTime":"","voucher":"","comments":"","notes":"","message":"","groupNote":"","custom1":"","custom2":"","custom3":"","custom4":"","custom5":"","custom6":"","custom7":"","custom8":"","custom9":"","custom10":"","flagColor":"","flagText":"","statusCode":0,"lang":"","referer":"pacartagena2","refererEditable":"pacartagena2","reference":"","channel":"direct","apiSourceId":0,"apiSource":"Direct","apiReference":"","allowChannelUpdate":"all","allowAutoAction":"enable","allowReview":"default","allowCancellation":{"type":"propertyDefault"},"invoiceeId":null,"bookingTime":"2025-08-16T03:48:25Z","modifiedTime":"2025-08-16T03:48:55Z","cancelTime":null,"infoItems":[],"price":0,"deposit":0,"tax":0,"commission":0,"rateDescription":"Oferta 1,","stripeToken":null,"apiMessage":""},"constraint":"P2011"}
    error: "\nInvalid `prisma.booking.upsert()` invocation:\n\n\nNull constraint violation on the fields: (`leadType`)"
INFO: ‚úÖ syncSingleBooking completed bookingId=74321990 action=skipped jobId=beds24-sync-74321990 {"jobId":"beds24-sync-74321990","bookingId":74321990,"syncResult":{"success":false,"action":"skipped","table":"Booking"},"success":false,"action":"skipped","table":"Booking"}
ERROR: ‚ùå Job processing failed at sync bookingId=74321990 action=MODIFY jobId=beds24-sync-74321990 {"jobId":"beds24-sync-74321990","stack":"Error: Sync failed: skipped - Booking\n    at Worker.connection [as processFn] (file:///app/data-sync/dist/infra/queues/queue.manager.js:55:27)\n    at async /app/data-sync/node_modules/bullmq/dist/cjs/classes/worker.js:496:32\n    at async Worker.retryIfFailed (/app/data-sync/node_modules/bullmq/dist/cjs/classes/worker.js:774:24)","step":"sync_phase","bookingId":74321990,"action":"MODIFY","duration":523}
    error: "Sync failed: skipped - Booking"
WARN: Job failed, will retry jobId=beds24-sync-74321990 {"jobId":"beds24-sync-74321990","attempt":1}
    error: "Sync failed: skipped - Booking"
INFO: Processing job jobId=beds24-sync-74321670 {"jobId":"beds24-sync-74321670","type":"beds24-webhook","attempt":3,"maxAttempts":3}
INFO: Processing Beds24 webhook bookingId=74321670 action=MODIFY jobId=beds24-sync-74321670 {"jobId":"beds24-sync-74321670","bookingId":74321670,"action":"MODIFY","webhookType":"beds24-webhook"}
INFO: Starting syncSingleBooking call bookingId=74321670 action=MODIFY jobId=beds24-sync-74321670 {"jobId":"beds24-sync-74321670","bookingId":74321670,"action":"MODIFY"}
INFO: Starting sync for booking bookingId=74321670 {"bookingId":74321670}
ERROR: ‚ùå Failed to sync to BD - check constraints and data bookingId=74321984 {"stack":"PrismaClientKnownRequestError: \nInvalid `prisma.booking.upsert()` invocation:\n\n\nNull constraint violation on the fields: (`leadType`)\n    at ei.handleRequestError (/app/data-sync/node_modules/.prisma/client/runtime/library.js:124:7283)\n    at ei.handleAndLogRequestError (/app/data-sync/node_modules/.prisma/client/runtime/library.js:124:6608)\n    at ei.request (/app/data-sync/node_modules/.prisma/client/runtime/library.js:124:6315)\n    at async a (/app/data-sync/node_modules/.prisma/client/runtime/library.js:133:9551)\n    at async processSingleBookingData (file:///app/data-sync/dist/providers/beds24/sync.js:76:24)\n    at async syncSingleBooking (file:///app/data-sync/dist/providers/beds24/sync.js:19:16)\n    at async Worker.connection [as processFn] (file:///app/data-sync/dist/infra/queues/queue.manager.js:45:36)\n    at async /app/data-sync/node_modules/bullmq/dist/cjs/classes/worker.js:496:32\n    at async Worker.retryIfFailed (/app/data-sync/node_modules/bullmq/dist/cjs/classes/worker.js:774:24)","bookingId":74321984,"data":{"id":74321984,"masterId":null,"propertyId":240061,"roomId":506591,"unitId":1,"roomQty":1,"offerId":1,"status":"confirmed","subStatus":"none","arrival":"2025-08-26","departure":"2025-08-28","numAdult":5,"numChild":0,"title":"RESERVA NUEVA","firstName":"","lastName":"","email":"","phone":"","mobile":"","fax":"","company":"","address":"","city":"","state":"","postcode":"","country":"","country2":null,"arrivalTime":"","voucher":"","comments":"","notes":"","message":"","groupNote":"","custom1":"","custom2":"","custom3":"","custom4":"","custom5":"","custom6":"","custom7":"","custom8":"","custom9":"","custom10":"","flagColor":"","flagText":"","statusCode":0,"lang":"","referer":"pacartagena2","refererEditable":"pacartagena2","reference":"","channel":"direct","apiSourceId":0,"apiSource":"Direct","apiReference":"","allowChannelUpdate":"all","allowAutoAction":"enable","allowReview":"default","allowCancellation":{"type":"propertyDefault"},"invoiceeId":null,"bookingTime":"2025-08-16T03:48:10Z","modifiedTime":"2025-08-16T03:48:41Z","cancelTime":null,"infoItems":[],"price":70000,"deposit":0,"tax":0,"commission":0,"rateDescription":"Oferta 1,","stripeToken":null,"apiMessage":""},"constraint":"P2011"}
    error: "\nInvalid `prisma.booking.upsert()` invocation:\n\n\nNull constraint violation on the fields: (`leadType`)"
INFO: ‚úÖ syncSingleBooking completed bookingId=74321984 action=skipped jobId=beds24-sync-74321984 {"jobId":"beds24-sync-74321984","bookingId":74321984,"syncResult":{"success":false,"action":"skipped","table":"Booking"},"success":false,"action":"skipped","table":"Booking"}
ERROR: ‚ùå Job processing failed at sync bookingId=74321984 action=MODIFY jobId=beds24-sync-74321984 {"jobId":"beds24-sync-74321984","stack":"Error: Sync failed: skipped - Booking\n    at Worker.connection [as processFn] (file:///app/data-sync/dist/infra/queues/queue.manager.js:55:27)\n    at async /app/data-sync/node_modules/bullmq/dist/cjs/classes/worker.js:496:32\n    at async Worker.retryIfFailed (/app/data-sync/node_modules/bullmq/dist/cjs/classes/worker.js:774:24)","step":"sync_phase","bookingId":74321984,"action":"MODIFY","duration":577}
    error: "Sync failed: skipped - Booking"
WARN: Job failed, will retry jobId=beds24-sync-74321984 {"jobId":"beds24-sync-74321984","attempt":1}
    error: "Sync failed: skipped - Booking"
INFO: Processing job jobId=beds24-sync-70836255 {"jobId":"beds24-sync-70836255","type":"beds24-webhook","attempt":3,"maxAttempts":3}
INFO: Processing Beds24 webhook bookingId=70836255 action=MODIFY jobId=beds24-sync-70836255 {"jobId":"beds24-sync-70836255","bookingId":70836255,"action":"MODIFY","webhookType":"beds24-webhook"}
INFO: Starting syncSingleBooking call bookingId=70836255 action=MODIFY jobId=beds24-sync-70836255 {"jobId":"beds24-sync-70836255","bookingId":70836255,"action":"MODIFY"}
INFO: Starting sync for booking bookingId=70836255 {"bookingId":70836255}
INFO: ‚úÖ Successfully synced to BD - Booking table bookingId=70836255 action=updated {"bookingId":"70836255","action":"updated","table":"Booking","resultId":102,"guestName":"Jeremy Quesada","phone":"+50685627688","status":"confirmed","bdStatus":"Futura Confirmada"}
INFO: ‚úÖ syncSingleBooking completed bookingId=70836255 action=updated jobId=beds24-sync-70836255 {"jobId":"beds24-sync-70836255","bookingId":70836255,"syncResult":{"success":true,"action":"updated","table":"Booking"},"success":true,"action":"updated","table":"Booking"}
INFO: Beds24 webhook job completed bookingId=70836255 action=MODIFY jobId=beds24-sync-70836255 {"jobId":"beds24-sync-70836255","bookingId":70836255,"action":"MODIFY","duration":390}
INFO: ‚úÖ Successfully synced to BD - Booking table bookingId=74321670 action=created {"bookingId":"74321670","action":"created","table":"Booking","resultId":5293,"guestName":"NUEVA CREADA - LUEGO CANCELADA","phone":"unknown","status":"cancelled","bdStatus":"Cancelada Futura"}
INFO: ‚úÖ syncSingleBooking completed bookingId=74321670 action=created jobId=beds24-sync-74321670 {"jobId":"beds24-sync-74321670","bookingId":74321670,"syncResult":{"success":true,"action":"created","table":"Booking"},"success":true,"action":"created","table":"Booking"}
INFO: Beds24 webhook job completed bookingId=74321670 action=MODIFY jobId=beds24-sync-74321670 {"jobId":"beds24-sync-74321670","bookingId":74321670,"action":"MODIFY","duration":494}
INFO: Processing job jobId=beds24-sync-74321990 {"jobId":"beds24-sync-74321990","type":"beds24-webhook","attempt":2,"maxAttempts":3}
INFO: Processing Beds24 webhook bookingId=74321990 action=MODIFY jobId=beds24-sync-74321990 {"jobId":"beds24-sync-74321990","bookingId":74321990,"action":"MODIFY","webhookType":"beds24-webhook"}
INFO: Starting syncSingleBooking call bookingId=74321990 action=MODIFY jobId=beds24-sync-74321990 {"jobId":"beds24-sync-74321990","bookingId":74321990,"action":"MODIFY"}
INFO: Starting sync for booking bookingId=74321990 {"bookingId":74321990}
INFO: Processing job jobId=beds24-sync-74321984 {"jobId":"beds24-sync-74321984","type":"beds24-webhook","attempt":2,"maxAttempts":3}
INFO: Processing Beds24 webhook bookingId=74321984 action=MODIFY jobId=beds24-sync-74321984 {"jobId":"beds24-sync-74321984","bookingId":74321984,"action":"MODIFY","webhookType":"beds24-webhook"}
INFO: Starting syncSingleBooking call bookingId=74321984 action=MODIFY jobId=beds24-sync-74321984 {"jobId":"beds24-sync-74321984","bookingId":74321984,"action":"MODIFY"}
INFO: Starting sync for booking bookingId=74321984 {"bookingId":74321984}
ERROR: ‚ùå Failed to sync to BD - check constraints and data bookingId=74321990 {"stack":"PrismaClientKnownRequestError: \nInvalid `prisma.booking.upsert()` invocation:\n\n\nNull constraint violation on the fields: (`leadType`)\n    at ei.handleRequestError (/app/data-sync/node_modules/.prisma/client/runtime/library.js:124:7283)\n    at ei.handleAndLogRequestError (/app/data-sync/node_modules/.prisma/client/runtime/library.js:124:6608)\n    at ei.request (/app/data-sync/node_modules/.prisma/client/runtime/library.js:124:6315)\n    at async a (/app/data-sync/node_modules/.prisma/client/runtime/library.js:133:9551)\n    at async processSingleBookingData (file:///app/data-sync/dist/providers/beds24/sync.js:76:24)\n    at async syncSingleBooking (file:///app/data-sync/dist/providers/beds24/sync.js:19:16)\n    at async Worker.connection [as processFn] (file:///app/data-sync/dist/infra/queues/queue.manager.js:45:36)\n    at async /app/data-sync/node_modules/bullmq/dist/cjs/classes/worker.js:496:32\n    at async Worker.retryIfFailed (/app/data-sync/node_modules/bullmq/dist/cjs/classes/worker.js:774:24)","bookingId":74321990,"data":{"id":74321990,"masterId":null,"propertyId":173308,"roomId":378317,"unitId":1,"roomQty":1,"offerId":1,"status":"confirmed","subStatus":"none","arrival":"2025-08-26","departure":"2025-08-28","numAdult":2,"numChild":0,"title":"RESERVA NUEVA 2","firstName":"CAMBIO","lastName":"","email":"","phone":"","mobile":"","fax":"","company":"","address":"","city":"","state":"","postcode":"","country":"","country2":null,"arrivalTime":"","voucher":"","comments":"","notes":"","message":"","groupNote":"","custom1":"","custom2":"","custom3":"","custom4":"","custom5":"","custom6":"","custom7":"","custom8":"","custom9":"","custom10":"","flagColor":"","flagText":"","statusCode":0,"lang":"","referer":"pacartagena2","refererEditable":"pacartagena2","reference":"","channel":"direct","apiSourceId":0,"apiSource":"Direct","apiReference":"","allowChannelUpdate":"all","allowAutoAction":"enable","allowReview":"default","allowCancellation":{"type":"propertyDefault"},"invoiceeId":null,"bookingTime":"2025-08-16T03:48:25Z","modifiedTime":"2025-08-16T03:48:55Z","cancelTime":null,"infoItems":[],"price":0,"deposit":0,"tax":0,"commission":0,"rateDescription":"Oferta 1,","stripeToken":null,"apiMessage":""},"constraint":"P2011"}
    error: "\nInvalid `prisma.booking.upsert()` invocation:\n\n\nNull constraint violation on the fields: (`leadType`)"
INFO: ‚úÖ syncSingleBooking completed bookingId=74321990 action=skipped jobId=beds24-sync-74321990 {"jobId":"beds24-sync-74321990","bookingId":74321990,"syncResult":{"success":false,"action":"skipped","table":"Booking"},"success":false,"action":"skipped","table":"Booking"}
ERROR: ‚ùå Job processing failed at sync bookingId=74321990 action=MODIFY jobId=beds24-sync-74321990 {"jobId":"beds24-sync-74321990","stack":"Error: Sync failed: skipped - Booking\n    at Worker.connection [as processFn] (file:///app/data-sync/dist/infra/queues/queue.manager.js:55:27)\n    at async /app/data-sync/node_modules/bullmq/dist/cjs/classes/worker.js:496:32\n    at async Worker.retryIfFailed (/app/data-sync/node_modules/bullmq/dist/cjs/classes/worker.js:774:24)","step":"sync_phase","bookingId":74321990,"action":"MODIFY","duration":377}
    error: "Sync failed: skipped - Booking"
WARN: Job failed, will retry jobId=beds24-sync-74321990 {"jobId":"beds24-sync-74321990","attempt":2}
    error: "Sync failed: skipped - Booking"
ERROR: ‚ùå Failed to sync to BD - check constraints and data bookingId=74321984 {"stack":"PrismaClientKnownRequestError: \nInvalid `prisma.booking.upsert()` invocation:\n\n\nNull constraint violation on the fields: (`leadType`)\n    at ei.handleRequestError (/app/data-sync/node_modules/.prisma/client/runtime/library.js:124:7283)\n    at ei.handleAndLogRequestError (/app/data-sync/node_modules/.prisma/client/runtime/library.js:124:6608)\n    at ei.request (/app/data-sync/node_modules/.prisma/client/runtime/library.js:124:6315)\n    at async a (/app/data-sync/node_modules/.prisma/client/runtime/library.js:133:9551)\n    at async processSingleBookingData (file:///app/data-sync/dist/providers/beds24/sync.js:76:24)\n    at async syncSingleBooking (file:///app/data-sync/dist/providers/beds24/sync.js:19:16)\n    at async Worker.connection [as processFn] (file:///app/data-sync/dist/infra/queues/queue.manager.js:45:36)\n    at async /app/data-sync/node_modules/bullmq/dist/cjs/classes/worker.js:496:32\n    at async Worker.retryIfFailed (/app/data-sync/node_modules/bullmq/dist/cjs/classes/worker.js:774:24)","bookingId":74321984,"data":{"id":74321984,"masterId":null,"propertyId":240061,"roomId":506591,"unitId":1,"roomQty":1,"offerId":1,"status":"confirmed","subStatus":"none","arrival":"2025-08-26","departure":"2025-08-28","numAdult":5,"numChild":0,"title":"RESERVA NUEVA","firstName":"","lastName":"","email":"","phone":"","mobile":"","fax":"","company":"","address":"","city":"","state":"","postcode":"","country":"","country2":null,"arrivalTime":"","voucher":"","comments":"","notes":"","message":"","groupNote":"","custom1":"","custom2":"","custom3":"","custom4":"","custom5":"","custom6":"","custom7":"","custom8":"","custom9":"","custom10":"","flagColor":"","flagText":"","statusCode":0,"lang":"","referer":"pacartagena2","refererEditable":"pacartagena2","reference":"","channel":"direct","apiSourceId":0,"apiSource":"Direct","apiReference":"","allowChannelUpdate":"all","allowAutoAction":"enable","allowReview":"default","allowCancellation":{"type":"propertyDefault"},"invoiceeId":null,"bookingTime":"2025-08-16T03:48:10Z","modifiedTime":"2025-08-16T03:48:41Z","cancelTime":null,"infoItems":[],"price":70000,"deposit":0,"tax":0,"commission":0,"rateDescription":"Oferta 1,","stripeToken":null,"apiMessage":""},"constraint":"P2011"}
    error: "\nInvalid `prisma.booking.upsert()` invocation:\n\n\nNull constraint violation on the fields: (`leadType`)"
INFO: ‚úÖ syncSingleBooking completed bookingId=74321984 action=skipped jobId=beds24-sync-74321984 {"jobId":"beds24-sync-74321984","bookingId":74321984,"syncResult":{"success":false,"action":"skipped","table":"Booking"},"success":false,"action":"skipped","table":"Booking"}
ERROR: ‚ùå Job processing failed at sync bookingId=74321984 action=MODIFY jobId=beds24-sync-74321984 {"jobId":"beds24-sync-74321984","stack":"Error: Sync failed: skipped - Booking\n    at Worker.connection [as processFn] (file:///app/data-sync/dist/infra/queues/queue.manager.js:55:27)\n    at async /app/data-sync/node_modules/bullmq/dist/cjs/classes/worker.js:496:32\n    at async Worker.retryIfFailed (/app/data-sync/node_modules/bullmq/dist/cjs/classes/worker.js:774:24)","step":"sync_phase","bookingId":74321984,"action":"MODIFY","duration":418}
    error: "Sync failed: skipped - Booking"
WARN: Job failed, will retry jobId=beds24-sync-74321984 {"jobId":"beds24-sync-74321984","attempt":2}
    error: "Sync failed: skipped - Booking"
